# processing CSF variables of interest
library(dplyr)

# CSF data load-in
upenn_csf_master<-readr::read_delim("C:\\Work Folder\\Amprion\\Source Data\\Source Data\\UPENNBIOMK_MASTER_FINAL.csv")
upenn_csf_master<-upenn_csf_master %>% 
  dplyr::filter(BATCH %in% c("UPENNBIOMK9","UPENNBIOMK10",
                             "UPENNBIOMK12","UPENNBIOMK13"))
upenn_csf_master<-upenn_csf_master %>% 
  dplyr::arrange(RUNDATE) %>% 
  dplyr::distinct_at(vars(RID,VISCODE2), .keep_all=TRUE)

upenn_merged_csf_biomarkers <- upenn_csf_master %>% 
  dplyr::mutate(ABETA=ABETA42)
upenn_merged_csf_biomarkers <- upenn_merged_csf_biomarkers %>% 
  dplyr::select(-VISCODE) %>% dplyr::rename(VISCODE=VISCODE2)
upenn_merged_csf_biomarkers <- upenn_merged_csf_biomarkers %>% 
  dplyr::mutate(ABETA=round(ABETA),
                ptau_pos=PTAU>21.8,
                AmyloidPosCSF=ABETA<980,
                ptau_ab_ratio=(as.numeric(PTAU)/as.numeric(ABETA)),ad_path_pos=ptau_ab_ratio>0.025)
upenn_merged_csf_biomarkers <- upenn_merged_csf_biomarkers %>% 
  dplyr::arrange(RUNDATE) %>% 
  dplyr::distinct_at(vars(RID,VISCODE), .keep_all=TRUE)

# split ABETA values here; values <200 or >1700 are usable for status assignment but not for numerical analysis
# don't need to split CSF PTAU - all values are within technical limits
upenn_merged_csf_biomarkers <- upenn_merged_csf_biomarkers %>% 
  dplyr::mutate(ABETA_for_status=ABETA,
                ABETA_for_biomarkers=case_when(ABETA>=200 & ABETA<=1700 ~ ABETA),
                RID = as.character(RID),
                VISCODE_csf = VISCODE)
